const S="https://api.pinata.cloud",g="https://gateway.pinata.cloud/ipfs";function u(){return localStorage.getItem("nulla_pinata_jwt")}function _(t){localStorage.setItem("nulla_pinata_jwt",t),console.log("[IPFS] Pinata JWT saved")}function F(){return!!u()}async function h(t){const o=u();if(!o)return console.warn("[IPFS] No Pinata JWT configured, using localStorage fallback"),i(t);try{const a=JSON.stringify(t),e=new Blob([a],{type:"application/json"}),r=new FormData;r.append("file",e,`nulla-soul-${Date.now()}.json`);const l=JSON.stringify({name:"Nulla Soul Snapshot",keyvalues:{stage:t.stage.toString(),xp:t.xp.toString(),timestamp:t.timestamp.toString()}});r.append("pinataMetadata",l);const n=await fetch(`${S}/pinning/pinFileToIPFS`,{method:"POST",headers:{Authorization:`Bearer ${o}`},body:r});if(!n.ok){const f=await n.json();throw new Error(`Pinata error: ${f.message||n.status}`)}const s=(await n.json()).IpfsHash,c=`${g}/${s}`;return console.log("[IPFS] Uploaded! Hash:",s),p(s,c),c}catch(a){return console.error("[IPFS] Upload failed:",a),i(t)}}async function d(t){try{if(t.startsWith("local://"))return y(t);const o=await fetch(t);if(!o.ok)throw new Error(`Fetch failed: ${o.status}`);return await o.json()}catch(o){return console.error("[IPFS] Fetch failed:",o),null}}async function m(t){const o=JSON.stringify(t),e=new TextEncoder().encode(o),r=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(r)).map(n=>n.toString(16).padStart(2,"0")).join("")}async function i(t){const a=(await m(t)).slice(0,16),e=JSON.stringify(t);return localStorage.setItem(`nulla_soul_${a}`,e),p(a,`local://${a}`),console.log("[Soul] Saved locally:",a),`local://${a}`}function y(t){const o=t.replace("local://",""),a=localStorage.getItem(`nulla_soul_${o}`);if(a)try{return JSON.parse(a)}catch{return null}return null}function p(t,o){const a={hash:t,uri:o,timestamp:Date.now()};localStorage.setItem("nulla_soul_latest",JSON.stringify(a));const e=JSON.parse(localStorage.getItem("nulla_soul_history")||"[]");e.unshift(a),localStorage.setItem("nulla_soul_history",JSON.stringify(e.slice(0,20)))}function w(){const t=localStorage.getItem("nulla_soul_latest");if(t)try{return JSON.parse(t)}catch{return null}return null}function I(t,o=[]){return{version:1,stage:t.stage||1,xp:t.xp||0,mood:t.mood||{glitchy:3,curious:4,protective:3},memories:o.slice(-50).map(a=>({type:a.type||"episodic",content:a.content||"",timestamp:a.timestamp||Date.now()})),conversationSummary:"",timestamp:Date.now()}}async function J(t){const o=I(t);return h(o)}async function N(){const t=w();return t?d(t.uri):null}export{J as backupSoul,I as createSoulSnapshot,d as fetchFromIPFS,w as getLatestBackup,F as isPinataConfigured,N as restoreLatestSoul,_ as setPinataJWT,h as uploadToIPFS};
