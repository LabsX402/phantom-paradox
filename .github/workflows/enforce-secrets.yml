name: Enforce Secrets Manager

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  check-secrets:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Check for API keys in env files
        run: |
          echo "üîç Checking for exposed API keys..."
          
          # Check .env files
          if [ -f .env ]; then
            if grep -q "PINATA_API_KEY=" .env || \
               grep -q "PINATA_SECRET_KEY=" .env || \
               grep -q "UPSTASH_REDIS_REST_TOKEN=" .env || \
               grep -q "AWS_SECRET_ACCESS_KEY=" .env; then
              echo "‚ùå API keys detected in .env file - use Secrets Manager"
              echo "   Move secrets to:"
              echo "   - Vercel: vercel env add"
              echo "   - AWS: AWS Secrets Manager"
              echo "   - GitHub: Repository Secrets"
              exit 1
            fi
          fi
          
          # Check for hardcoded keys in code
          if grep -r "PINATA_API_KEY.*=" offchain/src --exclude-dir=node_modules || \
             grep -r "AWS_SECRET_ACCESS_KEY.*=" offchain/src --exclude-dir=node_modules; then
            echo "‚ùå Hardcoded API keys detected in source code"
            echo "   Use environment variables or Secrets Manager"
            exit 1
          fi
          
          echo "‚úÖ No exposed API keys found"
      
      - name: Test environment fallbacks
        run: |
          echo "üß™ Testing environment variable fallbacks..."
          cd offchain
          
          # Test REDIS_TYPE fallback
          REDIS_TYPE=memory npm run test:serverless:workflow || echo "‚ö†Ô∏è  Fallback test had warnings"
          
          echo "‚úÖ Environment fallback tests completed"
      
      - name: Verify Secrets Manager usage
        run: |
          echo "üîê Verifying Secrets Manager configuration..."
          
          # Check if secrets are referenced correctly
          if ! grep -q "process.env" offchain/src/serverless/*.ts; then
            echo "‚ö†Ô∏è  Warning: Some files may not use environment variables"
          fi
          
          echo "‚úÖ Secrets Manager verification complete"

